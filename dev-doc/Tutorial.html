<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>tinyap: First steps with Tinyap</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<script type="text/javascript">
function hasClass(ele,cls) {
  return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

function toggleVisibility(linkObj) {
 var base = linkObj.getAttribute('id');
 var summary = document.getElementById(base + '-summary');
 var content = document.getElementById(base + '-content');
 var trigger = document.getElementById(base + '-trigger');
 if ( hasClass(linkObj,'closed') ) {
   summary.style.display = 'none';
   content.style.display = 'block';
   trigger.src = 'open.png';
   removeClass(linkObj,'closed');
   addClass(linkObj,'opened');
 } else if ( hasClass(linkObj,'opened') ) {
   summary.style.display = 'block';
   content.style.display = 'none';
   trigger.src = 'closed.png';
   removeClass(linkObj,'opened');
   addClass(linkObj,'closed');
 }
 return false;
}
</script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">tinyap&#160;<span id="projectnumber">2</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>First steps with Tinyap </h1>  </div>
</div>
<div class="contents">
<div class="textblock"><p>Author : Damien &ldquo;bl0b&rdquo; Leroux (damien <em>dot</em> leroux <em>at</em> gmail <em>dot</em> com)</p>
<p>This page explains how to fetch, install, run, understand and use tinyap. </p>
<h2><a class="anchor" id="t_toc"></a>
Contents</h2>
<div style="background-color:#E8E8E8; border:solid 1px #808080; width:300px; padding:6px;"> <a class="el" href="Tutorial.html#t_intr">Introduction</a> <br/>
 <a class="el" href="Tutorial.html#t_inst">I. Installation</a> <br/>
 <a class="el" href="Tutorial.html#t_gram">II. Meta-Grammar</a> <br/>
 <a class="el" href="Tutorial.html#t_usag">III. Usage</a> <br/>
 <a class="el" href="Tutorial.html#t_srlz">IV. (Un)Serialization of ASTs</a> <br/>
 <a class="el" href="Tutorial.html#t_walk">V. These apes are made for walking...</a> <br/>
 <a class="el" href="Tutorial.html#t_uprs">VI. Unparsing</a> <br/>
 <a class="el" href="Tutorial.html#t_api">VII. C API</a> <br/>
 </div> <h2><a class="anchor" id="t_intr"></a>
Introduction</h2>
<div align="center" style="margin:16px;"><em>&ldquo;One build to parse them all.&rdquo;</em></div><p>Tinyap is a parsing engine using a <a href="http://en.wikipedia.org/wiki/GLR_parser">GLR</a>-like algorithm. When a parse is successful, tinyap outputs an <a href="http://en.wikipedia.org/wiki/Abstract_syntax_tree">Abstract Syntax Tree (AST)</a> that represents the input text in a structured manner.</p>
<p>Unlike most parsers, its code isn't factory-calibrated for a particular grammar. Instead, the grammar is data. Tinyap uses an AST that represents a grammar to parse its input text. This grammar AST is structured according to <a class="el" href="Tutorial.html#t_gram">tinyap's grammar description language</a>.</p>
<p>The factory default for the grammar AST is the <a class="el" href="Tutorial.html#t_gram">grammar description language</a> itself. So one can parse a grammar description and directly use the parse output to parse some other text written in the described language. Tinyap also features a plugin mechanism for grammars, which allows for dynamic modular grammars. The ASTs tinyap produces can be serialized to and deserialized from buffers and files.</p>
<p>Tinyap also provides an interface to walk down the ASTs and makes it easy to write external plugins to visit the nodes, e.g. a compiler, an interpreter, a static evaluator, a renderer...</p>
<p>Finally, tinyap is also able to create text back from an AST, providing special non-terminals such as <code>Space</code>, <code>NewLine</code>, <code>Indent</code> and <code>Dedent</code>, that don't influence the parse and serve only to format the output text.</p>
<p>You can have a look at an extensive use of tinyap at <a href="http://code.google.com/p/tinyaml">http://code.google.com/p/tinyaml</a> where tinyap is used to parse compile and extend a base meta-language.</p>
<h2><a class="anchor" id="t_inst"></a>
I. Installation</h2>
<p>First, get the source code. </p>
<ul>
<li>
<b>download a tarball</b> : (development version 2.0-beta used in the example below, you can download the latest at <a href="http://www.github.com/bl0b/tinyap">http://www.github.com/bl0b/tinyap</a>). <div class="fragment"><pre class="fragment"> TODO
</pre></div> </li>
<li>
<b>using git</b> : <div class="fragment"><pre class="fragment"> TODO
</pre></div> </li>
</ul>
<p>Now you have your tinyap source distribution at hands, build it. </p>
<div class="fragment"><pre class="fragment"> $ cd tinyap
 TODO currently, go to src/lr and there is no make install
 $ make all
 $ make install
</pre></div><p> You might need root privileges to run make install. </p>
<ul>
<li></li>
</ul>
<h2><a class="anchor" id="t_gram"></a>
II. Meta-Grammar</h2>
<div align="center" style="margin:16px;"><em>&ldquo;The language is that of EBNF, which I will not utter here. In the common tongue it says...&rdquo;</em></div><p>The way the parser produces its output is driven by the grammar it uses. A grammar is a set of production rules. Each rule associates a symbolic name and one or more elements that the rule will produce. Each element successfully parsed is converted in an AST node and the full AST is built from the rightmost derivation of the rules. When a rule successfully produces its elements, it can evaluate to a new operator node and enclose its produced nodes with a label (these rules are called operator rules), or evaluate to its produced nodes silently (these rules are called transient rules). Transient rules are useful to implement loops and split rules.</p>
<p>The parser distinguishes information from garbage. A special rule defines the garbage characters to strip from the input between two elements. Terminal strings don't contain information (other than structuring the text) and are not included in the output.</p>
<p>Element types</p>
<ul>
<li><code>non_terminal</code> : the parser will try to produce the rule named "non_terminal", and append the result to output.</li>
<li><code>"terminal"</code> : the parser will try to produce the string "terminal" at its current position, and discard it.</li>
<li><code>/reg-exp/</code> : the parser will search for a match at its current position, and append the match string to output.</li>
<li><code>~X</code>,Y~ : the parser will try to produce a string delimited by X and Y and append it to the output. For instance, ~","~ for a C-string or ~//,<br/>
~ for a C++ comment.</li>
<li><code>~bagowords~</code> : the parser will try to produce a string from this "bag of words", and discard it.</li>
<li><code>~bagowords!~</code> : the parser will try to produce a string from this "bag of words", and append it to the output.</li>
</ul>
<p>Expressions</p>
<ul>
<li>Sequence <div class="fragment"><pre class="fragment"> expression expression... 
</pre></div> produce all children from left to right</li>
<li>Selection <div class="fragment"><pre class="fragment"> expression | expression | ... 
</pre></div> try all children from left to right until successful.</li>
<li>Prefix <div class="fragment"><pre class="fragment"> [ expression ] &lt;non-terminal&gt; 
</pre></div> produce expression, produce non-terminal, insert expression at head of non-terminal's children, evaluate to non-terminal</li>
<li>Postfix (much useless) <div class="fragment"><pre class="fragment"> { expression } &lt;non-terminal&gt; 
</pre></div> same as prefix, but insert expression at tail of non-terminal's children</li>
<li>Repetition operators <div class="fragment"><pre class="fragment"> expression*   # match expression zero or more times (behaves like expr_loop = ( &lt;expression&gt; &lt;expr_loop&gt; | epsilon ). )
 expression?   <span class="preprocessor"># match expression zero or one time (behaves like opt_expr = ( &lt;expression&gt; | epsilon ). )</span>
<span class="preprocessor"> expression+   # match expression one or more times (behaves like expr = &lt;expression&gt; &lt;expr_loop&gt;. ) </span>
</pre></div> Parenthesis can be used to delimit sub-expressions.</li>
</ul>
<p>Rules</p>
<ul>
<li>Operator rules <div class="fragment"><pre class="fragment"> symbol ::= expression . 
</pre></div> produce an operator node labeled "symbol"</li>
<li>Transient rules <div class="fragment"><pre class="fragment"> symbol = expression . 
</pre></div> produce expression</li>
<li>_start : tinyap searches for this rule to start a parse.</li>
<li>_whitespace : tinyap searches for a string or a regexp in the right-hand side expression, and uses it as the garbage characters pattern.</li>
</ul>
<p>Special symbols</p>
<ul>
<li><code>epsilon</code> : produce the empty string (never fails)</li>
<li><code>EOF</code> : produce the end of file</li>
</ul>
<p>Grammar plugins </p>
<div class="fragment"><pre class="fragment"> plugin_rule = ( A | B | ... ). 
</pre></div><p> tinyap can plug new alternatives in rules where the right-hand side expression is a selection (see <a class="el" href="Tutorial.html#t_api">VII. C API</a>).</p>
<p>Here is the full grammar description language expressed with itself : </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor"># TinyaP : this is not yet another </span>
<span class="preprocessor"></span><span class="preprocessor"># Copyright (C) 2007-2011 Damien Leroux</span>
<span class="preprocessor"></span><span class="preprocessor">#</span>
<span class="preprocessor"></span><span class="preprocessor"># This program is free software; you can redistribute it and/or</span>
<span class="preprocessor"></span><span class="preprocessor"># modify it under the terms of the GNU General Public License</span>
<span class="preprocessor"></span><span class="preprocessor"># as published by the Free Software Foundation; either version 2</span>
<span class="preprocessor"></span><span class="preprocessor"># of the License, or (at your option) any later version.</span>
<span class="preprocessor"></span><span class="preprocessor">#</span>
<span class="preprocessor"></span><span class="preprocessor"># This program is distributed in the hope that it will be useful,</span>
<span class="preprocessor"></span><span class="preprocessor"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="preprocessor"></span><span class="preprocessor"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="preprocessor"></span><span class="preprocessor"># GNU General Public License for more details.</span>
<span class="preprocessor"></span><span class="preprocessor">#</span>
<span class="preprocessor"></span><span class="preprocessor"># You should have received a copy of the GNU General Public License</span>
<span class="preprocessor"></span><span class="preprocessor"># along with this program; if not, write to the Free Software</span>
<span class="preprocessor"></span><span class="preprocessor"># Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="preprocessor"></span><span class="preprocessor">#</span>
<span class="preprocessor"></span><span class="preprocessor">#</span>
<span class="preprocessor"></span><span class="preprocessor"># Production Atoms</span>
<span class="preprocessor"></span><span class="preprocessor">#</span>
<span class="preprocessor"></span>symbol = /[_a-zA-Z][0-9a-zA-Z_]*/.
T ::= ~<span class="stringliteral">&quot;,&quot;</span>~.
NT ::= symbol.
RE ::= ~/,/~.
STR ::= .raw <span class="stringliteral">&quot;~&quot;</span> /[^~,]?/ <span class="stringliteral">&quot;,&quot;</span> /[^~,]?/ <span class="stringliteral">&quot;~&quot;</span>.
BOW ::= .raw <span class="stringliteral">&quot;~&quot;</span> /[_a-zA-Z][_a-zA-Z0-9]*/ /!?/ <span class="stringliteral">&quot;~&quot;</span>.
AddToBag ::= RE <span class="stringliteral">&quot;:&quot;</span> symbol /!?/.
#
<span class="preprocessor"># Compositions</span>
<span class="preprocessor"></span><span class="preprocessor">#</span>
<span class="preprocessor"></span>RawSeq ::= <span class="stringliteral">&quot;.raw&quot;</span> (.space (T | STR | RE | BOW | AddToBag))+.
alt_elem = RawSeq | Seq | single.
Seq ::= single (.space single)+.
Alt ::= alt_elem (.space <span class="stringliteral">&quot;|&quot;</span> .space alt_elem)+.
Rep01 ::= single_norep <span class="stringliteral">&quot;?&quot;</span>.
Rep1N ::= single_norep <span class="stringliteral">&quot;+&quot;</span>.
Rep0N ::= single_norep <span class="stringliteral">&quot;*&quot;</span>.
single = Rep01 | Rep0N | Rep1N | single_norep | Space | NewLine | Indent | Dedent.
single_norep = Prefix | Postfix | NT | STR | BOW | AddToBag | T | RE | Epsilon | EOF | sub_rmb.
Prefix ::= <span class="stringliteral">&quot;[&quot;</span> rmember <span class="stringliteral">&quot;]&quot;</span> NT.
Postfix ::= <span class="stringliteral">&quot;{&quot;</span> rmember <span class="stringliteral">&quot;}&quot;</span> NT.
#
<span class="preprocessor"># Top-level</span>
<span class="preprocessor"></span><span class="preprocessor">#</span>
<span class="preprocessor"></span>TransientRule ::= symbol .space <span class="stringliteral">&quot;=&quot;</span> .space rmember <span class="stringliteral">&quot;.&quot;</span> .newline.
OperatorRule ::= symbol .space <span class="stringliteral">&quot;::=&quot;</span> .space rmember <span class="stringliteral">&quot;.&quot;</span> .newline.
rmember = Alt | alt_elem.
sub_rmb = <span class="stringliteral">&quot;(&quot;</span> (Seq | Alt | RawSeq) <span class="stringliteral">&quot;)&quot;</span>.
Comment ::= /#.*/ .newline.
Grammar ::= gram_toplevel+.
gram_toplevel = TransientRule | OperatorRule | Comment.
#
# Miscellaneous
#
_start = Grammar.
_whitespace = /[ \r\n\t]+/.
EOF ::= <span class="stringliteral">&quot;.eof&quot;</span>.
Epsilon ::= <span class="stringliteral">&quot;.epsilon&quot;</span>.
Space ::= <span class="stringliteral">&quot;.space&quot;</span>.
NewLine ::= <span class="stringliteral">&quot;.newline&quot;</span>.
Indent ::= <span class="stringliteral">&quot;.indent&quot;</span>.
Dedent ::= <span class="stringliteral">&quot;.dedent&quot;</span>.
</pre></div><p>Below is a condensed grammar to parse arithmetic expressions. It will be used in the following examples : </p>
<div class="fragment"><pre class="fragment">number ::= /[0-9]+/.

m_expr ::= expr4.

m_minus ::= <span class="stringliteral">&quot;-&quot;</span> number.
m_div ::= ( m_div <span class="stringliteral">&quot;/&quot;</span> expr0 | expr0 <span class="stringliteral">&quot;/&quot;</span> expr0 ).
m_mul ::= ( m_mul <span class="stringliteral">&quot;*&quot;</span> expr1 | expr1 <span class="stringliteral">&quot;*&quot;</span> expr1 ).
m_sub ::= ( m_sub <span class="stringliteral">&quot;-&quot;</span> expr2 | expr2 <span class="stringliteral">&quot;-&quot;</span> expr2 ).
m_add ::= ( m_add <span class="stringliteral">&quot;+&quot;</span> expr3 | expr3 <span class="stringliteral">&quot;+&quot;</span> expr3 ).

expr0 = ( m_minus | number | <span class="stringliteral">&quot;(&quot;</span> m_expr <span class="stringliteral">&quot;)&quot;</span> ).
expr1 = ( m_div | expr0 ).
expr2 = ( m_mul | expr1 ).
expr3 = ( m_sub | expr2 ).
expr4 = ( m_add | expr3 ).

_expr = m_expr <span class="stringliteral">&quot;;&quot;</span>.

_start = ( .eof
         | _expr _start
         ).

</pre></div><p> Notice that number, m_expr, m_mul, m_sub, m_add, m_div are operator rules. These are the labels we'll have in the nodes of the parse results.</p>
<h2><a class="anchor" id="t_usag"></a>
III. Usage</h2>
<div align="center" style="margin:16px;"><em>&ldquo;First shalt thou take out the Holy Command Line, then shalt thou count to three, no more, no less.<br/>
Three shall be the number thou shalt count, and the number of the counting shall be three.&rdquo;</em></div><p>When invoked, tinyap executes each of its command-line arguments from left to right.</p>
<ul>
<li>--version,-v display version</li>
<li>--verbose,-V output messages during parse</li>
<li>--quiet,-q don't output messages during parse (default)</li>
<li>--grammar,-g name use this grammar to parse input "short" (default) selects default meta-grammar any other string is a filename to read grammar from</li>
<li>--print-grammar,-pg output the current grammar in `explicit' dialect argument is the same as above</li>
<li>--input,-i name text source to use<ul>
<li>(default) selects standard input any other string is a filename to read from</li>
</ul>
</li>
<li>--output,-o name redirect serialized AST output<ul>
<li>(default) selects standard output any other string is a filename to write to</li>
</ul>
</li>
<li>--parse,-p parse input text</li>
<li>--parse-as-grammar,-pag parse input text and use output AST as new grammar</li>
<li>--full-parse,-fp find all possible parse trees</li>
<li>--parse,-p parse input text favoring shift over reduce</li>
<li>--dump-stack,-ds [dotFile] dump the LR stack as a .dot file</li>
<li>--print-states,-ps print the LR(0) states to standard output</li>
<li>--walk,-w name walk the current output tree using named ape (try prettyprint !)</li>
<li>--help,-h display this text</li>
</ul>
<p>Examples : (assuming you're in ./examples/)</p>
<ul>
<li>first use : <div class="fragment"><pre class="fragment"> $ tinyap -h 
</pre></div></li>
<li>display the default meta-grammar : <div class="fragment"><pre class="fragment"> $ tinyap -pg 
</pre></div></li>
<li>parse a grammar : <div class="fragment"><pre class="fragment"> $ tinyap -i math.gram -pag 
</pre></div></li>
<li>parse something and display the result tree : <div class="fragment"><pre class="fragment"> $ tinyap -i math.gram -p -w prettyprint 
</pre></div></li>
<li>parse a grammar and a text file : <div class="fragment"><pre class="fragment"> $ tinyap -i math.gram -pag -i test.math -p 
</pre></div></li>
<li>evaluate the operations in test2.math : <div class="fragment"><pre class="fragment">$ gcc -shared ape_tinycalc.o -o libape_tinycalc.so # you may need to build the shared object
$ LD_LIBRARY_PATH=. tinyap -i math.gram -pag -i test2.math -p -w tinycalc </pre></div></li>
</ul>
<h2><a class="anchor" id="t_srlz"></a>
IV. (Un)Serialization of ASTs</h2>
<p>Tinyap makes it easy writing and reading ASTs to and from files and buffers. Serialized ASTs can be directly used as grammars : </p>
<div class="fragment"><pre class="fragment">
 $ tinyap -i math.gram -p -o math.gram.srlz                 # parse and serialize math.gram
 $ tinyap -g math.gram.srlz -i test2.math -p -w tinycalc    # using math.gram, parse test2.math and evaluate the operations </pre></div><p>The <a class="el" href="Tutorial.html#t_api">C API</a> provides more means to serialize and unserialize ASTs to/from files and buffers. Such interactions are pointless in command line.</p>
<h2><a class="anchor" id="t_walk"></a>
V. These apes are made for walking...</h2>
<div align="center" style="margin:16px;"><em>&ldquo;...And that's just what they'll do : one of these days these apes are gonna walk 'ver the output.&rdquo;</em></div><p> Tinyap provides an interface to easily write AST evaluators (hence the name, tinyap evaluator -&gt; tinyape -&gt; ape).</p>
<p>An evaluator has to provide four functions :</p>
<ul>
<li>init : receives data under the form of a <code>void*</code> and has to initialize the ape.</li>
<li>term : terminate the ape.</li>
<li>result : has to return the result of the ape's evaluation.</li>
<li>default : this visit method is called whenever no specific visit method has been defined for an operator node.</li>
</ul>
<p>Visit methods take the current node as an argument and return the direction for the next step in walk. Directions can be :</p>
<ul>
<li>Up : to parent node</li>
<li>Down : walk on each child node (operands)</li>
<li>Next : walk to next sibling node (or is equivalent to "Up-Next" on the last child of a node)</li>
<li>Done : evaluation is over and successful.</li>
<li>Error : evaluation failed.</li>
</ul>
<p>Each method of an evaluator must be named as follows :</p>
<p><b>ape_</b> <em>evaluator_name</em> <b>_</b> <em>method</em> </p>
<p><em>method</em> is <code>init</code>, <code>term</code>, <code>result</code>, <code>default</code>, or an operator label.</p>
<p>Tinyap handles the actual walking depending on evaluator's direction returns, and invokes the proper evaluator's visit method at each step.</p>
<p>Here is the code for the pretty-printer (invoke it in command line with "-w prettyprint") : </p>
<div class="fragment"><pre class="fragment"><span class="comment">/* Tinya(J)P : this is not yet another (Java) parser.</span>
<span class="comment"> * Copyright (C) 2007 Damien Leroux</span>
<span class="comment"> *</span>
<span class="comment"> * This program is free software; you can redistribute it and/or</span>
<span class="comment"> * modify it under the terms of the GNU General Public License</span>
<span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<span class="comment"> * of the License, or (at your option) any later version.</span>
<span class="comment"> *</span>
<span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="comment"> * GNU General Public License for more details.</span>
<span class="comment"> *</span>
<span class="comment"> * You should have received a copy of the GNU General Public License</span>
<span class="comment"> * along with this program; if not, write to the Free Software</span>
<span class="comment"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="comment"> */</span>

<span class="preprocessor">#include &quot;config.h&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="tinyap_8h.html">tinyap.h</a>&quot;</span>
<span class="preprocessor">#include &quot;pilot_manager.h&quot;</span>
<span class="preprocessor">#include &quot;walker.h&quot;</span>


<span class="keywordtype">void</span>* ape_prettyprint_init(<span class="keywordtype">void</span>* init_data) { <span class="keywordflow">return</span> NULL; }

<span class="keywordtype">void</span> ape_prettyprint_free(<span class="keywordtype">void</span>*data) {}

<span class="keywordtype">void</span> prettyprint_node_header(<a class="code" href="tinyap_8h.html#ae26934fb321486ad6619df824143effa">wast_t</a> father, <a class="code" href="tinyap_8h.html#ae26934fb321486ad6619df824143effa">wast_t</a> node) {
        <span class="keywordtype">char</span> c[4]={<span class="charliteral">&#39; &#39;</span>,<span class="charliteral">&#39; &#39;</span>,0,0};
        <span class="keywordflow">if</span>(!father) {
                <span class="keywordflow">return</span>;
        }
        <span class="keywordflow">if</span>(!node) {
                c[1]=<span class="charliteral">&#39;-&#39;</span>;
                node=father;
                father=<a class="code" href="tinyape_8h.html#abd9ac008737bca96f0dd9cc89f18b7a2" title="get a node&amp;#39;s father">wa_father</a>(node);
        }
        <span class="keywordflow">if</span>(father) {
                prettyprint_node_header(<a class="code" href="tinyape_8h.html#abd9ac008737bca96f0dd9cc89f18b7a2" title="get a node&amp;#39;s father">wa_father</a>(father), father);
                <span class="keywordflow">if</span>(<a class="code" href="tinyape_8h.html#abc8106097beeab152cbaf083ac49a3a9" title="get a node&amp;#39;s child">wa_opd</a>(father,<a class="code" href="tinyape_8h.html#abc13b376a968c7c35ec80b7eae99a27c" title="get a node&amp;#39;s children count">wa_opd_count</a>(father)-1)!=node) {
                        c[0] = <span class="charliteral">&#39;|&#39;</span>;
                } <span class="keywordflow">else</span> {
                        <span class="keywordflow">if</span>(c[1]==<span class="charliteral">&#39;-&#39;</span>) {
                                c[0] = <span class="charliteral">&#39;`&#39;</span>;
                        }
                }
                fputs(c,stdout);
        }
}



<a class="code" href="tinyape_8h.html#adb15513cd72241e3bee754e8c1f5d3ca" title="Walk directions to use in returns from visit methods.">WalkDirection</a> ape_prettyprint_default(<a class="code" href="tinyap_8h.html#ae26934fb321486ad6619df824143effa">wast_t</a> node, <span class="keywordtype">void</span>*___) {
        prettyprint_node_header(node,NULL);
        puts(<a class="code" href="tinyape_8h.html#aac01743cffae6ffee46a289e2a7598e7" title="get a node&amp;#39;s label">wa_op</a>(node));

        <span class="keywordflow">if</span>(<a class="code" href="tinyape_8h.html#abc13b376a968c7c35ec80b7eae99a27c" title="get a node&amp;#39;s children count">wa_opd_count</a>(node)) {
                <span class="keywordflow">return</span> <a class="code" href="tinyape_8h.html#adb15513cd72241e3bee754e8c1f5d3caabcf8c79e9a5f5f9d606fb35645a0fb27" title="to first child">Down</a>;
        } <span class="keywordflow">else</span> {
                <span class="keywordflow">return</span> <a class="code" href="tinyape_8h.html#adb15513cd72241e3bee754e8c1f5d3caab6505f468e0e75bc3fdc7f47c22384a4" title="to next sibling">Next</a>;
        }
}
</pre></div><p>And here is the code for the tiny calculator "tinycalc" (seen in the examples above) : </p>
<div class="fragment"><pre class="fragment"><span class="comment">/* Tinya(J)P : this is not yet another (Java) parser.</span>
<span class="comment"> * Copyright (C) 2007 Damien Leroux</span>
<span class="comment"> *</span>
<span class="comment"> * This program is free software; you can redistribute it and/or</span>
<span class="comment"> * modify it under the terms of the GNU General Public License</span>
<span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<span class="comment"> * of the License, or (at your option) any later version.</span>
<span class="comment"> *</span>
<span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="comment"> * GNU General Public License for more details.</span>
<span class="comment"> *</span>
<span class="comment"> * You should have received a copy of the GNU General Public License</span>
<span class="comment"> * along with this program; if not, write to the Free Software</span>
<span class="comment"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="comment"> */</span>

<span class="preprocessor">#include &quot;../src/tinyape.h&quot;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>

<span class="keyword">typedef</span> <span class="keyword">struct </span>_tc_struc {
        <span class="keywordtype">int</span> result;
        <span class="keywordtype">int</span> is_toplevel;
}* tc_t;

<span class="keywordtype">void</span>* ape_tinycalc_init(<span class="keywordtype">void</span>* init_data) {
        tc_t tc = (tc_t) malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> _tc_struc));

        tc-&gt;is_toplevel = init_data==NULL;

        <span class="keywordflow">return</span> tc;
}

<span class="keywordtype">void</span>* ape_tinycalc_result(tc_t i) {
        <span class="keywordflow">if</span>(i-&gt;is_toplevel) {
                printf(<span class="stringliteral">&quot;result = %i\n&quot;</span>,i-&gt;result);
        }
        <span class="keywordflow">return</span> (<span class="keywordtype">void</span>*)i-&gt;result;
}

<span class="keywordtype">void</span> ape_tinycalc_free(tc_t data) {
        free(data);
}

<a class="code" href="tinyape_8h.html#adb15513cd72241e3bee754e8c1f5d3ca" title="Walk directions to use in returns from visit methods.">WalkDirection</a> ape_tinycalc_default(<a class="code" href="tinyap_8h.html#ae26934fb321486ad6619df824143effa">wast_t</a> node, tc_t <span class="keyword">this</span>) {
        printf(<span class="stringliteral">&quot;unknown node %s\n&quot;</span>,<a class="code" href="tinyape_8h.html#aac01743cffae6ffee46a289e2a7598e7" title="get a node&amp;#39;s label">wa_op</a>(node));
        <span class="keywordflow">return</span> <a class="code" href="tinyape_8h.html#adb15513cd72241e3bee754e8c1f5d3caaa7929b884d7db9093d6ed453feedf2a2" title="success">Done</a>;
}

<a class="code" href="tinyape_8h.html#adb15513cd72241e3bee754e8c1f5d3ca" title="Walk directions to use in returns from visit methods.">WalkDirection</a> ape_tinycalc_number(<a class="code" href="tinyap_8h.html#ae26934fb321486ad6619df824143effa">wast_t</a> node, tc_t <span class="keyword">this</span>) {
        this-&gt;result = atoi(<a class="code" href="tinyape_8h.html#aac01743cffae6ffee46a289e2a7598e7" title="get a node&amp;#39;s label">wa_op</a>(<a class="code" href="tinyape_8h.html#abc8106097beeab152cbaf083ac49a3a9" title="get a node&amp;#39;s child">wa_opd</a>(node,0)));
        <span class="keywordflow">return</span> <a class="code" href="tinyape_8h.html#adb15513cd72241e3bee754e8c1f5d3caaa7929b884d7db9093d6ed453feedf2a2" title="success">Done</a>;
}

<a class="code" href="tinyape_8h.html#adb15513cd72241e3bee754e8c1f5d3ca" title="Walk directions to use in returns from visit methods.">WalkDirection</a> ape_tinycalc_m_add(<a class="code" href="tinyap_8h.html#ae26934fb321486ad6619df824143effa">wast_t</a> node, tc_t <span class="keyword">this</span>) {
        <span class="keywordtype">int</span> a = (int)<a class="code" href="group__api__ast.html#gae6c8ac64a37fd638c198dd789fb50fa5" title="walk this subtree using this named pilot with this init data.">tinyap_walk</a>(<a class="code" href="tinyape_8h.html#abc8106097beeab152cbaf083ac49a3a9" title="get a node&amp;#39;s child">wa_opd</a>(node,0),<span class="stringliteral">&quot;tinycalc&quot;</span>,<span class="keyword">this</span>);
        <span class="keywordtype">int</span> b = (int)<a class="code" href="group__api__ast.html#gae6c8ac64a37fd638c198dd789fb50fa5" title="walk this subtree using this named pilot with this init data.">tinyap_walk</a>(<a class="code" href="tinyape_8h.html#abc8106097beeab152cbaf083ac49a3a9" title="get a node&amp;#39;s child">wa_opd</a>(node,1),<span class="stringliteral">&quot;tinycalc&quot;</span>,<span class="keyword">this</span>);
        this-&gt;result = a + b;
        <span class="keywordflow">return</span> <a class="code" href="tinyape_8h.html#adb15513cd72241e3bee754e8c1f5d3caaa7929b884d7db9093d6ed453feedf2a2" title="success">Done</a>;
}

<a class="code" href="tinyape_8h.html#adb15513cd72241e3bee754e8c1f5d3ca" title="Walk directions to use in returns from visit methods.">WalkDirection</a> ape_tinycalc_m_sub(<a class="code" href="tinyap_8h.html#ae26934fb321486ad6619df824143effa">wast_t</a> node, tc_t <span class="keyword">this</span>) {
        <span class="keywordtype">int</span> a = (int)<a class="code" href="group__api__ast.html#gae6c8ac64a37fd638c198dd789fb50fa5" title="walk this subtree using this named pilot with this init data.">tinyap_walk</a>(<a class="code" href="tinyape_8h.html#abc8106097beeab152cbaf083ac49a3a9" title="get a node&amp;#39;s child">wa_opd</a>(node,0),<span class="stringliteral">&quot;tinycalc&quot;</span>,<span class="keyword">this</span>);
        <span class="keywordtype">int</span> b = (int)<a class="code" href="group__api__ast.html#gae6c8ac64a37fd638c198dd789fb50fa5" title="walk this subtree using this named pilot with this init data.">tinyap_walk</a>(<a class="code" href="tinyape_8h.html#abc8106097beeab152cbaf083ac49a3a9" title="get a node&amp;#39;s child">wa_opd</a>(node,1),<span class="stringliteral">&quot;tinycalc&quot;</span>,<span class="keyword">this</span>);
        this-&gt;result = a - b;
        <span class="keywordflow">return</span> <a class="code" href="tinyape_8h.html#adb15513cd72241e3bee754e8c1f5d3caaa7929b884d7db9093d6ed453feedf2a2" title="success">Done</a>;
}

<a class="code" href="tinyape_8h.html#adb15513cd72241e3bee754e8c1f5d3ca" title="Walk directions to use in returns from visit methods.">WalkDirection</a> ape_tinycalc_m_mul(<a class="code" href="tinyap_8h.html#ae26934fb321486ad6619df824143effa">wast_t</a> node, tc_t <span class="keyword">this</span>) {
        <span class="keywordtype">int</span> a = (int)<a class="code" href="group__api__ast.html#gae6c8ac64a37fd638c198dd789fb50fa5" title="walk this subtree using this named pilot with this init data.">tinyap_walk</a>(<a class="code" href="tinyape_8h.html#abc8106097beeab152cbaf083ac49a3a9" title="get a node&amp;#39;s child">wa_opd</a>(node,0),<span class="stringliteral">&quot;tinycalc&quot;</span>,<span class="keyword">this</span>);
        <span class="keywordtype">int</span> b = (int)<a class="code" href="group__api__ast.html#gae6c8ac64a37fd638c198dd789fb50fa5" title="walk this subtree using this named pilot with this init data.">tinyap_walk</a>(<a class="code" href="tinyape_8h.html#abc8106097beeab152cbaf083ac49a3a9" title="get a node&amp;#39;s child">wa_opd</a>(node,1),<span class="stringliteral">&quot;tinycalc&quot;</span>,<span class="keyword">this</span>);
        this-&gt;result = a * b;
        <span class="keywordflow">return</span> <a class="code" href="tinyape_8h.html#adb15513cd72241e3bee754e8c1f5d3caaa7929b884d7db9093d6ed453feedf2a2" title="success">Done</a>;
}

<a class="code" href="tinyape_8h.html#adb15513cd72241e3bee754e8c1f5d3ca" title="Walk directions to use in returns from visit methods.">WalkDirection</a> ape_tinycalc_m_div(<a class="code" href="tinyap_8h.html#ae26934fb321486ad6619df824143effa">wast_t</a> node, tc_t <span class="keyword">this</span>) {
        <span class="keywordtype">int</span> a = (int)<a class="code" href="group__api__ast.html#gae6c8ac64a37fd638c198dd789fb50fa5" title="walk this subtree using this named pilot with this init data.">tinyap_walk</a>(<a class="code" href="tinyape_8h.html#abc8106097beeab152cbaf083ac49a3a9" title="get a node&amp;#39;s child">wa_opd</a>(node,0),<span class="stringliteral">&quot;tinycalc&quot;</span>,<span class="keyword">this</span>);
        <span class="keywordtype">int</span> b = (int)<a class="code" href="group__api__ast.html#gae6c8ac64a37fd638c198dd789fb50fa5" title="walk this subtree using this named pilot with this init data.">tinyap_walk</a>(<a class="code" href="tinyape_8h.html#abc8106097beeab152cbaf083ac49a3a9" title="get a node&amp;#39;s child">wa_opd</a>(node,1),<span class="stringliteral">&quot;tinycalc&quot;</span>,<span class="keyword">this</span>);
        this-&gt;result = a / b;
        <span class="keywordflow">return</span> <a class="code" href="tinyape_8h.html#adb15513cd72241e3bee754e8c1f5d3caaa7929b884d7db9093d6ed453feedf2a2" title="success">Done</a>;
}

<a class="code" href="tinyape_8h.html#adb15513cd72241e3bee754e8c1f5d3ca" title="Walk directions to use in returns from visit methods.">WalkDirection</a> ape_tinycalc_m_minus(<a class="code" href="tinyap_8h.html#ae26934fb321486ad6619df824143effa">wast_t</a> node, tc_t <span class="keyword">this</span>) {
        <span class="keywordtype">int</span> a = (int)<a class="code" href="group__api__ast.html#gae6c8ac64a37fd638c198dd789fb50fa5" title="walk this subtree using this named pilot with this init data.">tinyap_walk</a>(<a class="code" href="tinyape_8h.html#abc8106097beeab152cbaf083ac49a3a9" title="get a node&amp;#39;s child">wa_opd</a>(node,0),<span class="stringliteral">&quot;tinycalc&quot;</span>,<span class="keyword">this</span>);
        this-&gt;result = - a;
        <span class="keywordflow">return</span> <a class="code" href="tinyape_8h.html#adb15513cd72241e3bee754e8c1f5d3caaa7929b884d7db9093d6ed453feedf2a2" title="success">Done</a>;
}

<a class="code" href="tinyape_8h.html#adb15513cd72241e3bee754e8c1f5d3ca" title="Walk directions to use in returns from visit methods.">WalkDirection</a> ape_tinycalc_m_expr(<a class="code" href="tinyap_8h.html#ae26934fb321486ad6619df824143effa">wast_t</a> node, tc_t <span class="keyword">this</span>) {
        <span class="keywordflow">return</span> <a class="code" href="tinyape_8h.html#adb15513cd72241e3bee754e8c1f5d3caabcf8c79e9a5f5f9d606fb35645a0fb27" title="to first child">Down</a>;
}

</pre></div><h2><a class="anchor" id="t_uprs"></a>
VI. Unparsing</h2>
<p>With using a grammar and an AST, create back the text buffer that generated this AST when parsed with this grammar.</p>
<p>This can be useful for data (un)serialization, as well as syntax highlighting and source code reformatting.</p>
<p>Tinyap recognizes the special pseudo-elements <code>Space</code>, <code>Indent</code>, <code>Dedent</code>, and <code>NewLine</code>. These elements are ignored when parsing text, and used to perform indentation when unparsing an AST. A special grammar rule indent may define the indentation string. Tinyap defaults to the tab character if this rule is not defined. Space is used to force a white space between similar tokens, or to ensure formatting. Many Space elements in a row will insert only one space.</p>
<dl class="note"><dt><b>Note:</b></dt><dd>The grammar used to unparse is not required to be the same grammar used for parsing. It is only required to define all the rules that match the AST labels.</dd></dl>
<p>Detailed pseudo-elements behaviour :</p>
<ul>
<li><code>Space</code> : insert one space into output text. More than one <code>Space</code> elements in a row will produce one single space character in the output text.</li>
<li><code>NewLine</code> : insert a NewLine ('<br/>
') character into output text, followed by as many <code>_indent</code> strings as the current indent level.</li>
<li><code>Indent</code> : increment indent level and insert one <code>_indent</code> string into the output text.</li>
<li><code>Dedent</code> : decrement indent level and remove the last <code>_indent</code> string from output text.</li>
</ul>
<p>Quick output formatting how-to :</p>
<p>It is quite straightforward to include formatting elements in a grammar, for instance to add color or typefaces to the output text, without interfering with parsing input text.</p>
<p>Using terminals and the <code></code>? operator, one can define optional elements that will be taken into account only at unparsing time. Example : </p>
<div class="fragment"><pre class="fragment">        _start = foobar.
        foobar ::= <span class="stringliteral">&quot;&lt;em&gt;&quot;</span>? /(foo|bar|baz)+/ <span class="stringliteral">&quot;&lt;/em&gt;&quot;</span>?.
</pre></div><p> The text "foobarbazfoo" will be recognized by this rule, because the <code></code>? operators allow the terminals to be omitted. The corresponding AST (foobar foobarbazfoo) will be unparsed to "&lt;em&gt;foobarbazfoo&lt;/em&gt;" because unparsing always tries to produce optional elements.</p>
<p>Moreover, it is easy to define <b>configurable</b> formatters : </p>
<div class="fragment"><pre class="fragment">        _start = foobar.
        foo_prefix = ( <span class="stringliteral">&quot;&lt;em&gt;&quot;</span> ).
        foo_suffix = ( <span class="stringliteral">&quot;&lt;/em&gt;&quot;</span> ).
        foobar ::= foo_prefix? /(foo|bar|baz)+/ foo_suffix?.
</pre></div><p>Prefix and Suffix are defined as pluggable rules. Now, just plug a new formatting terminal in each rule. Unparsing will always use the last formatting terminal plugged in.</p>
<p>For instance :</p>
<ul>
<li>Unparsing (foobar foobarbazfoo) gives "&lt;em&gt;foobarbazfoo&lt;/em&gt;".</li>
<li>Plug "PFX" into <code>foo_prefix</code>.</li>
<li>Plug "SFX" into <code>foo_suffix</code>.</li>
<li>Unparsing (foobar foobarbazfoo) now gives "PFXfoobarbazfooSFX".</li>
</ul>
<h2><a class="anchor" id="t_api"></a>
VII. C API</h2>
<dl class="see"><dt><b>See also:</b></dt><dd><a class="el" href="tinyap_8h.html">tinyap.h</a> </dd>
<dd>
<a class="el" href="tinyape_8h.html">tinyape.h</a></dd></dl>
</div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Fri Sep 23 2011 09:29:10 for tinyap by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
